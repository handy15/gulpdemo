function onSlide(e,t){appVM.startDay!=t[0]&&appVM.endDay!=t[1]||(appVM.startDay=d3.min(t),appVM.endDay=d3.max(t),debounceZooming())}function formatDateRange(e){return e.map(function(e,t){return[e.getFullYear(),("0"+(e.getMonth()+1)).slice(-2),("0"+e.getDate()).slice(-2)].join("-")})}function debounce(e,t,a){var o;return function(){var s=this,d=arguments,n=function(){o=null,a||e.apply(s,d)},i=a&&!o;clearTimeout(o),o=setTimeout(n,t),i&&e.apply(s,d)}}function mouseMove(e,t,a){var o,s,d=d3.mouse(this);return tipVM.top=d[1]+80,tipVM.left=d[0]+(options.width-d[0]>335?100:-210),!(!appVM.states.isZoomIn&&tipVM.date===a.date&&tipVM.data===e.values[a.dateIndex].value)&&(tipVM.date=a.date,void(appVM.states.isZoomIn?(o=a.dataPoints.filter(function(e){return format(e.date)===a.date}).slice(appVM.startDay,appVM.endDay+1),s=d3.sum(o,function(e){return e.value}),tipVM.select="在"+dayFormat(+e.key.slice(1))+"新增（占"+dayFormat(appVM.startDay)+"至"+dayFormat(appVM.endDay)+"新增的当天活跃用户比：",tipVM.data=e.values[a.dateIndex].value+" ("+(e.values[a.dateIndex].value/s*100).toFixed(2)+"%)",tipVM.sumTitle=dayFormat(appVM.startDay)+"至"+dayFormat(appVM.endDay)+"新增的当天活跃用户：",tipVM.total=s):(tipVM.select="在"+dayFormat(+e.key.slice(1))+"新增（占当日活跃比）: ",tipVM.data=e.values[a.dateIndex].value+" ("+(e.values[a.dateIndex].value/a.sum*100).toFixed(2)+"%)",tipVM.sumTitle="当日全部活跃：",tipVM.total=a.sum)))}function dayFormat(e){return 0==e?"当天":31==e?"30+天前":e+"天前"}function onSlide(e,t){appVM.startDay!=t[0]&&appVM.endDay!=t[1]||(appVM.startDay=d3.min(t),appVM.endDay=d3.max(t),debounceZooming())}var now=new Date,format=d3.time.format("%Y-%m-%d"),options={chart:"#viz",width:document.getElementsByClassName("mod-body")[0].offsetWidth,height:600,mouseOver:function(){tipVM.states.isShow=!0},mouseOut:function(){tipVM.states.isShow=!1},loaded:function(){document.getElementsByClassName("wait-load")[0].style.display="none"},failed:function(){document.getElementById("error-info").style.display="",document.getElementById("viz").style.display="none"}},showingMethodsTabVM=new Vue({el:"#showing-methods-tab",data:{tabs:[{name:"绝对值",value:"zero"},{name:"百分比",value:"expand"}],activeIndex:0},computed:{offset:function(){return this.tabs[this.activeIndex].value}},methods:{onClickTab:function(e,t){this.activeIndex!==t&&(this.activeIndex=t),streamChart.draw({offset:e.value}),appVM.states.isZoomIn&&appVM.$emit("zoomIn")}}}),paletteVM=new Vue({el:"#color-container",data:{colors:[1,2,3],selectColorCate:"color-category1",states:{isShow:!1}},methods:{togglePalette:function(e){e.stopPropagation(),this.states.isShow=!this.states.isShow},onClickColor:function(e,t,a){a.stopPropagation(),this.selectColorCate="color-category"+e,document.getElementById("chart-slider").className="d3-slider d3-slider-horizontal slider-color-category"+e,appVM.$emit("changeColor",t),streamChart.draw({offset:showingMethodsTabVM.offset}),appVM.states.isZoomIn&&appVM.$emit("zoomIn")}}}),tipVM=new Vue({el:"#tip",data:{date:null,select:null,data:null,sumTitle:null,total:null,tipType:"当日",top:0,left:0,states:{isShow:!1}}});document.addEventListener("click",function(){paletteVM.states.isShow=!1});var debounceZooming=debounce(function(){appVM.$emit("zoomIn")},200),slider=d3.slider().value([0,7]).min(0).max(31).step(1).axis(d3.svg.axis().orient("bottom").ticks(4)).on("slide",onSlide),colorCategory=[["#2f62b7","#3166b8","#336aba","#356ebb","#3772bc","#3976bd","#3c7abf","#3e7ec0","#4082c1","#4286c3","#448ac4","#468ec5","#4892c6","#4a96c8","#4c9ac9","#4e9eca","#51a1cc","#53a5cd","#55a9ce","#57add0","#59b1d1","#5bb5d2","#5db9d3","#5fbdd5","#61c1d6","#63c5d7","#66c9d9","#68cdda","#6ad1db","#6cd5dc","#6ed9de","#70dddf"],["#3c8ec7","#3f91c3","#4294bf","#4497bc","#479ab8","#4a9db4","#4da0b0","#4fa3ac","#52a5a9","#55a8a5","#58aba1","#5bae9d","#5db199","#60b496","#63b792","#66ba8e","#68bd8a","#6bc086","#6ec382","#71c67f","#73c97b","#76cc77","#79cf73","#7cd26f","#7fd46c","#81d768","#84da64","#87dd60","#8ae05c","#8ce359","#8fe655","#92e951"],["#f58863","#f18a66","#ed8d68","#e98f6b","#e5926e","#e19471","#dd9773","#d99976","#d69c79","#d29e7c","#cea17e","#caa381","#c6a684","#c2a887","#beab89","#baad8c","#b6b08f","#b2b292","#aeb594","#aab797","#a6ba9a","#a2bc9d","#9ebf9f","#9ac1a2","#97c4a5","#93c6a8","#8fc9aa","#8bcbad","#87ceb0","#83d0b3","#7fd3b5","#7bd5b8"]];options=$.extend(options,{colors:colorCategory[0],url:"/apps/reports/load_chart_data?stats=freshness&start_date="+format(new Date(now.getTime()-7776e6))+"&end_date="+format(now),mouseMove:mouseMove}),Vue.filter("dayFormat",dayFormat);var appVM=new Vue({el:".wrap-table",data:{startDay:0,endDay:7,states:{isZoomIn:!1}},watch:{"states.isZoomIn":function(e,t){e?this.$emit("zoomIn"):streamChart.draw({offset:showingMethodsTabVM.offset})}},ready:function(){this.$on("zoomIn",function(){streamChart.zoomLayers(32-appVM.startDay,31-appVM.endDay)}),this.$on("changeColor",function(e){streamChart.setColor(colorCategory[e])})},methods:{exportBasicReport:function(e){var t=streamChart.getDateRange();t[0]=new Date(t[0].getTime()+864e5),t=formatDateRange(t),$(e.target)._export(e,{url:"/apps/"+UMENG.APPKEY+"/reports/load_table_data",stats:"freshness_csv",start_date:t[0],end_date:t[1]})}}});$(function(){streamChart.init(options),d3.select("#chart-slider").call(slider),setTimeout(function(){options.url="/addd/sss",$("#chart-slider").empty(),$("svg").remove(),paletteVM.selectColorCate="color-category1",appVM.startDay=0,appVM.endDay=7,appVM.states.isZoomIn=!1,document.getElementById("chart-slider").className="d3-slider d3-slider-horizontal slider-color-category1",streamChart.init(options),slider=d3.slider().value([0,7]).min(0).max(31).step(1).axis(d3.svg.axis().orient("bottom").ticks(4)).on("slide",onSlide),d3.select("#chart-slider").call(slider)},6e3)});