var WIDTH=$(".wau-graph").width(),HEIGHT=600,BAR_HEIGHT=50,BAR_MARGIN=400,LINK_HIDE_OPACITY=.05,LINK_NORMAL_OPACITY=.3,LINK_HIGH_OPACITY=.7,isIE9=navigator.userAgent.indexOf("MSIE 9.0")>0,isIE10=navigator.userAgent.indexOf("MSIE 10.0")>0,wau=d3.wau().size([WIDTH,HEIGHT]),wauGraph=function(t){var e,a,n,r,i,o,l="",s=d3.scale.ordinal().domain(["R1","R2~R4","RN","R2N","N","L1","L2~L4","LN"]).range(["#F7A897","#C9342F","#AF1923","#DD5143","#7CB82F","#9BDAF3","#009FDF","#004673"]);return{init:function(t,o){e=d3.select(".wau-graph").append("svg").attr("width",WIDTH).attr("height",HEIGHT),a=e.append("defs").append("filter").attr("id","gray").append("feColorMatrix").attr("type","matrix").attr("values","0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0  0  0  1 0"),gradient=e.select("defs").append("linearGradient").attr("id","grad").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%"),gradient.append("stop").attr("offset","20%").attr("stop-color","rgb(255, 255, 255)").attr("stop-opacity",0),gradient.append("stop").attr("offset","100%").attr("stop-color","rgb(0, 70, 115)").attr("stop-opacity",1),n=e.append("g").attr("class","date-group"),r=e.append("g").attr("class","active-group"),i=e.append("g").attr("class","loss-group"),this.loadData(t,function(t){o(t)})},loadData:function(t,e){e({result:"succeed",dates:["2017-03-26","2017-04-02"],stats:[{N:{value:688,fullname:"新增用户",next:{L1:489,"R2~R4":199}},L1:{value:1482,fullname:"本周流失用户",next:{"L2~L4":1257,R1:225}},"L2~L4":{value:3593,fullname:"近期连续流失用户",next:{LN:1070,"L2~L4":2309,R1:214}},LN:{value:277,fullname:"长期流失用户",next:{R1:277}},R1:{value:666,fullname:"回流用户",next:{L1:470,"R2~R4":196}},"R2~R4":{value:727,fullname:"连续活跃用户",next:{L1:315,"R2~R4":318,RN:94}},RN:{value:1134,fullname:"忠诚用户",next:{L1:94,RN:1040}}},{N:{value:751,fullname:"新增用户"}}]})},drawGraph:function(e){var a=d3.time.format("%-m月%-d日"),l=new Date(e.dates[0]);t.data(e.stats[0]).layout(),o=t.widthScale(),n.translate([0,0]),r.translate([t.activeOffset,0]),i.translate([t.lossOffset,BAR_HEIGHT]),n.append("text").attr("x",20).attr("y",80).text(a(l)+"~"+a(new Date(l.setDate(l.getDate()+6)))),n.append("text").attr("x",20).attr("y",480).text(a(new Date(l.setDate(l.getDate()+1)))+"~"+a(new Date(l.setDate(l.getDate()+6)))),this.drawBar(r,"this",t.thisWeekR(),0),this.drawBar(r,"next",t.nextWeekR(),BAR_MARGIN),this.drawBar(i,"this",t.thisWeekL(),0),this.drawBar(i,"next",t.nextWeekL(),BAR_MARGIN),this.drawLink(r,t.computeLink()),this.drawLink(i,t.computeLossLink());var s=t.nextWeekL().filter(function(t){return"R1"===t.name})[0],u=e.stats[1].N;u.name="N";var d=i.selectAll(".next-week-n").data([u]).enter().append("g").attr("class","next-week-n").attr("data-type","r").attr("data-week","next").attr("opacity",1).translate(function(t){return t.v0=s.v0-t.value,[o(t.v0),BAR_HEIGHT]});this.drawSegment(d,BAR_MARGIN),this.drawText(d,BAR_MARGIN+30),i.selectAll(".loss-dim").data([0,BAR_MARGIN]).enter().append("rect").attr("class",function(t,e){return t?"next-week":"this-week"}).attr("x",-50).attr("y",function(t){return t}).attr("width",BAR_HEIGHT).attr("height",50).attr("data-type","l").attr("data-id","LN").attr("fill","url(#grad)")},clear:function(){[n.node(),r.node(),i.node()].forEach(function(t){for(var e;e=t.lastChild;)t.removeChild(e)})},reDraw:function(e){t.size([e,600]).layout(),o=t.widthScale(),d3.select(".wau-graph svg").attr("width",e),r.transition().translate([t.activeOffset,0]),i.transition().translate([t.lossOffset,BAR_HEIGHT]),d3.selectAll("g.this-week, g.next-week").transition().translate(function(t){return[o(t.v0),0]}),d3.selectAll("g.next-week-n").transition().translate(function(t){return[o(t.v0),BAR_HEIGHT]}),d3.selectAll(".this-week rect, .next-week rect, .next-week-n rect").transition().attr("width",function(t){return o(t.value)}),d3.selectAll(".link").transition().attr("d",t.link),d3.selectAll(".label").transition().attr("x",t.textX)},drawBar:function(t,e,a,n){var r=this.drawSegmentGroups(t,e,a);this.drawSegment(r,n),this.drawText(r,n+30)},drawSegmentGroups:function(t,e,a){var n=this,r=e+"-week";return t.selectAll("."+r).data(a).enter().append("g").attr("class",r).attr("data-id",function(t){return t.name}).attr("data-type",function(t){return t.name.indexOf("L")===-1?"r":"l"}).attr("data-week",e).translate(function(t){return[o(t.v0),0]}).on("mouseenter",function(t){d3.event.stopPropagation();var a="[data-"+("this"===e?"from":"to")+'="'+t.name+'"]',r="."+this.parentNode.className.baseVal,i=l!==r;d3.selectAll(a).transition("meopacity").duration(50).attr("opacity",LINK_HIGH_OPACITY),i&&(l=r,n.toFront(r))}).on("mouseleave",function(t){d3.event.stopPropagation();var e="."+this.parentNode.className.baseVal,a=".loss-group"===e?".active-group":".loss-group";d3.selectAll(".label").transition("mlopacity").duration(50).attr("opacity",0),d3.selectAll(".link").transition("opacity2").duration(50).attr("opacity",LINK_HIDE_OPACITY),isIE9||isIE10?d3.selectAll(a).transition("opacity2").duration(90).attr("opacity",1):d3.selectAll(a).transition("opacity2").duration(90).attr("opacity",1).style("filter",""),n.resetHighlight(),l=""})},drawSegment:function(t,e){t.append("rect").attr("x",0).attr("y",e).attr("width",function(t){return o(t.value)}).attr("height",BAR_HEIGHT).attr("fill",function(t){return s(t.name)}).attr("data-name",function(t){return t.name}),t.append("title").text(function(t){return t.fullname})},drawText:function(t,e){t.append("text").attr("x",0).attr("y",e).attr("fill","#fff").translate([6,0]).text(function(t){return t.fullname})},drawLink:function(e,a){e.selectAll(".link").data(a).enter().append("path").attr("class","link").attr("d",t.link).attr("opacity",.05).attr("data-from",function(t){return t.from}).attr("data-to",function(t){return t.to}).attr("fill",function(t){return s(t.from)}),e.selectAll(".label").data(a).enter().append("text").attr("class","label").attr("x",t.textX).attr("y",function(t,e){return BAR_MARGIN/2+e%4*20}).attr("opacity","0").attr("data-from",function(t){return t.from}).attr("data-to",function(t){return t.to}).attr("text-anchor","middle").text(function(t){return t.value+"("+(t.value/t.total*100).toFixed(2)+"%)"})},reorderDOM:function(t){var e=document.querySelector(t);document.querySelector("svg").appendChild(e)},toFront:function(t){var e=".loss-group"===t?".active-group":".loss-group";d3.select(t).transition("opacity").duration(100).attr("opacity",1).style("filter",""),isIE9||isIE10?d3.select(e).transition("opacity2").duration(110).attr("opacity",.2):d3.select(e).transition("opacity2").duration(110).attr("opacity",.2).style("filter","url(#gray)")},resetHighlight:function(){d3.selectAll(".link").interrupt().transition("opacity2").duration(50).attr("opacity",LINK_HIDE_OPACITY),d3.selectAll(".active-group, .loss-group").transition("opacity2").duration(90).attr("opacity",1).style("filter","")},highlight:function(t){d3.selectAll(t).transition("highlight-opacity").attr("opacity",1).style("filter","")},unHighlight:function(t){isIE9||isIE10?d3.selectAll(t).transition("highlight-opacity").attr("opacity",LINK_NORMAL_OPACITY):d3.selectAll(t).transition("highlight-opacity").attr("opacity",LINK_NORMAL_OPACITY).style("filter","url(#gray)")}}}(wau);$(function(){function t(){$(".js-weekly-active-user").on("mouseenter",function(){e(),wauGraph.unHighlight('[data-type="l"]')}).on("mouseleave",function(){a(),wauGraph.highlight('[data-type="l"]')}),$(".js-weekly-loss-user").on("mouseenter",function(){e(),wauGraph.unHighlight('[data-type="r"]')}).on("mouseleave",function(){a(),wauGraph.highlight('[data-type="r"]')}),$(".js-user-transfer").on("mouseenter",function(){var t=d3.select(this).classed("js-active");t?wauGraph.toFront(".active-group"):(wauGraph.toFront(".loss-group"),wauGraph.unHighlight(".next-week-n")),d3.selectAll(".link").transition("opacity").duration(50).attr("opacity",LINK_HIGH_OPACITY)}).on("mouseleave",function(){wauGraph.highlight(".next-week-n"),wauGraph.resetHighlight()}),$(".js-user-retention").on("mouseenter",function(){d3.selectAll('.link[data-to="R2~R4"], .link[data-to="RN"]').transition("opacity").duration(100).attr("opacity",LINK_HIGH_OPACITY),wauGraph.unHighlight('[data-type="l"]'),wauGraph.toFront(".active-group")}).on("mouseleave",function(){wauGraph.highlight('[data-type="l"]'),wauGraph.resetHighlight()}),$(".js-user-loss").on("mouseenter",function(){d3.selectAll('.link[data-to="L1"]').transition("opacity").duration(100).attr("opacity",LINK_HIGH_OPACITY),wauGraph.unHighlight('.next-week[data-id="R2~R4"], .next-week[data-id="RN"]'),wauGraph.toFront(".active-group")}).on("mouseleave",function(){wauGraph.highlight('.next-week[data-id="R2~R4"], .next-week[data-id="RN"]'),wauGraph.resetHighlight()}),$(".js-user-back").on("mouseenter",function(){d3.selectAll('.link[data-to="R1"]').transition("opacity").duration(100).attr("opacity",LINK_HIGH_OPACITY),wauGraph.unHighlight('.next-week[data-id="L2~L4"], .next-week[data-id="LN"], .next-week-n'),wauGraph.toFront(".loss-group")}).on("mouseleave",function(){wauGraph.highlight('.next-week[data-id="L2~L4"], .next-week[data-id="LN"], .next-week-n'),wauGraph.resetHighlight()}),$(".js-retention-coefficient").on("mouseenter",function(){e(),wauGraph.unHighlight('[data-type="l"], .next-week[data-id="R1"], .next-week-n')}).on("mouseleave",function(){a(),wauGraph.highlight('[data-type="l"], .next-week[data-id="R1"], .next-week-n')}),$(".js-reflux-coefficient").on("mouseenter",function(){wauGraph.unHighlight('.active-group .next-week, .next-week-n, [data-type="l"]'),d3.selectAll(".link").transition("opacity").attr("opacity",0)}).on("mouseleave",function(){wauGraph.highlight('.active-group .next-week, .next-week-n, [data-type="l"]'),d3.selectAll(".link").transition("opacity").attr("opacity",LINK_HIDE_OPACITY)}),$(".js-balance-coefficient").on("mouseenter",function(){e(),wauGraph.unHighlight('[data-type="l"], .next-week-n')}).on("mouseleave",function(){a(),wauGraph.highlight('[data-type="l"], .next-week-n')}),$(".js-change-coefficient").on("mouseenter",function(){e(),wauGraph.unHighlight('[data-type="l"]')}).on("mouseleave",function(){a(),wauGraph.highlight('[data-type="l"]')})}function e(){var t=d3.transform(d3.select('.next-week[data-id="R1"]').attr("transform")).translate[0],e=d3.transform(d3.select(".next-week-n").attr("transform")).translate[0];d3.select('.next-week[data-id="R1"]').transition("move").translate([t,-BAR_HEIGHT]),d3.select(".next-week-n").transition("move").translate([e,-BAR_HEIGHT]),d3.select('.next-week[data-id="L1"]').transition("move").translate([t-wau.activeOffset+wau.lossOffset,BAR_HEIGHT]),d3.selectAll(".link").transition("opacity").attr("opacity",0)}function a(){var t=d3.transform(d3.select('.next-week[data-id="R1"]').attr("transform")).translate[0],e=d3.transform(d3.select(".next-week-n").attr("transform")).translate[0];d3.select('.next-week[data-id="R1"]').transition("move2").translate([t,0]),d3.select(".next-week-n").transition("move2").translate([e,BAR_HEIGHT]),d3.select('.next-week[data-id="L1"]').transition("move2").translate([0,0]),d3.selectAll(".link").transition("opacity2").attr("opacity",LINK_HIDE_OPACITY)}function n(t,e,a){var n;return function(){var r=this,i=arguments,o=function(){n=null,a||t.apply(r,i)},l=a&&!n;clearTimeout(n),n=setTimeout(o,e),l&&t.apply(r,i)}}var r=d3.time.format("%Y-%m-%d"),i=d3.time.format("%Y.%m.%d"),o=d3.time.saturday.floor(new Date),l=d3.time.sunday.floor(new Date);$(".datepickerPanelArea .start").text(i(new Date(o.getTime()-11232e5))),$(".datepickerPanelArea .end").text(i(new Date(o.getTime()-6048e5))),wauGraph.init(r(new Date(l.getTime()-12096e5)),function(e){$(".wait-load").hide(),"succeed"===e.result?(wauGraph.drawGraph(e),t(),window.addEventListener("resize",n(function(){wauGraph.reDraw($(".wau-graph").width())},250))):($(".wau-graph",".graph-container").css("height","0"),$(".error-info",".graph-container").show())}),$(".datepickerPanelArea").jCalArea({monthSelect:!1,daySelect:!1,dCheck:function(t){return t<new Date(o.getTime()-5184e5)},dow:"日,一,二,三,四,五,六".split(","),timeUnit:"weekly",forceWeek:!0,dayOffset:0,buttons:[{name:"确定",click:function(t,e){$(".date-yesterday").removeClass("on"),$(".wait-load").show(),$(".error-info",".graph-container").hide(),$(".wau-graph",".graph-container").css("height","600px"),wauGraph.clear(),wauGraph.loadData(e[0],function(t){$(".wait-load").hide(),wauGraph.drawGraph(t)})}}]})});