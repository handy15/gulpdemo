d3.wau=function(){function e(e){var r=Object.keys(e),f={};return r.forEach(function(t,r){n(e[t].next,function(e,n){f[n]?f[n].value+=e:f[n]={value:e,fullname:u.fullnameMapping[n]}})}),t(f)}function n(e,t,r){function u(e,n,t,r){return e.call(r,n[t],t,n)}var f;for(f in e)if(u(t,e,f,r)===!1)break;return n}function t(e){var t=[];return n(e,function(e,n){e.name=n,t.push(e)}),t}function r(e,n){return e.name>n.name?1:e.name<n.name?-1:0}var u={},f={},i=[1,1],a=50,o=150,v=400,l=null,c=null,x=d3.scale.linear();return u.layout=function(){var n,r,a=this;return l=t(f),c=e(f),n=d3.sum(a.thisWeekR(),function(e){return e.value}),r=d3.sum(a.thisWeekL(),function(e){return e.value}),a.L1=a.nextWeekR().filter(function(e){return"L1"===e.name})[0].value,a.graphWidth=d3.sum(c,function(e){return e.value})-a.L1,x.range([0,i[0]-o]).nice(1).domain([0,a.graphWidth]),a.activeOffset=i[0]-x(n)-10,a.lossOffset=a.activeOffset-x(r-a.L1),u},u.link=function(e){var n=x(e.x0),t=x(e.x1),r=x(e.value);return"M "+n+","+a+" L"+t+","+v+" H"+(t+r)+" L"+(n+r)+","+a+" Z"},u.textX=function(e){var n=x(e.x0),t=x(e.x1),r=x(e.value);return(n+t+r)/2},u.activeUser=["R1","R2~R4","R2N","RN","N"],u.activeUserNext=["L1","R2~R4","R2N","RN"],u.fullnameMapping={N:"新增用户",R1:"回流用户",R2N:"上周新增用户","R2~R4":"连续活跃用户",RN:"忠诚用户",L1:"本周流失用户","L2~L4":"近期连续流失用户",LN:"新增长期流失用户"},u.thisWeek=function(){return l},u.thisWeekR=function(){var e=l.filter(function(e){return!(e.name.indexOf("L")>-1)});e.sort(r);for(var n=0;n<e.length;n++)if(0===n)e[n].v0=0;else{var t=e[n-1];e[n].v0=t.v0+t.value}return e},u.nextWeekR=function(){for(var e=c.filter(function(e,n){return["L1","R2~R4","R2N","RN"].indexOf(e.name)>-1}),n=0;n<e.length;n++)if(0===n)e[n].v0=0;else{e[n-1];e[n].v0=e[n-1].v0+e[n-1].value}return e},u.thisWeekL=function(){var e=l.filter(function(e){return e.name.indexOf("L")>-1});e.sort(r).reverse();for(var n=0;n<e.length;n++)if(0===n)e[n].v0=0;else{var t=e[n-1];e[n].v0=t.v0+t.value}return e},u.nextWeekL=function(){var e=c.filter(function(e){return["L2~L4","LN","R1"].indexOf(e.name)>-1});e.sort(r).reverse(),e.push(e.shift());for(var n=0;n<e.length;n++)if(0===n)e[n].v0=0;else{var t=e[n-1];e[n].v0=t.v0+t.value}return e},u.computeLink=function(){var e=this.thisWeekR(),n=this.nextWeekR(),t={},r=[];return e.forEach(function(e,u){e.offset=0;for(next in e.next){var f=n.filter(function(e){return e.name===next})[0].v0;t[next]=t[next]||0,r.push({from:e.name,to:next,x0:e.v0+e.offset,x1:f+t[next],value:e.next[next],total:e.value}),e.offset+=e.next[next],t[next]+=e.next[next]}}),r},u.computeLossLink=function(){var e=this.thisWeekL(),n=this.nextWeekL(),t={},r=[];return e.forEach(function(e,u){e.offset=0;for(next in e.next){var f=n.filter(function(e){return e.name===next})[0].v0;t[next]=t[next]||0,r.push({from:e.name,to:next,x0:e.v0+e.offset,x1:f+t[next],value:e.next[next],total:e.value}),e.offset+=e.next[next],t[next]+=e.next[next]}}),r},u.data=function(e){return arguments.length?(f=e,u):f},u.widthScale=function(e){return arguments.length?(x=e,u):x},u.size=function(e){return arguments.length?(i=e,u):i},u.barHeight=function(e){return arguments.length?(a=e,u):a},u.weekPadding=function(e){return arguments.length?(v=e,u):v},u};